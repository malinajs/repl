(()=>{function g(e){e=e||self;let n=[],r=(o,i)=>{n.push({event:o,handler:i})},t=(o,i)=>{n.filter(y=>y.event!==o&&y.handler!==i)},a=(o,i)=>{e.postMessage({event:o,details:i})};return e.addEventListener("message",({data:o})=>{n.filter(i=>i.event===o.event).forEach(i=>i.handler(o.details))}),{on:r,off:t,emit:a}}var s="modules",h="https://unpkg.com";var j=["rollup","acorn","astring","csstree","cjs2es"];function _(e){return self[e]!==void 0}function c(e){if(!_(e))throw new Error(`[REPL]: Dependency not initialized: ${e}`)}function $(){for(let e of j)importScripts(`${s}/${e}.js`),c(e);self["css-tree"]=self.csstree}function f(e){if(e=e||"latest",_("malina")){if(malina.version===e)return;delete self.malina}try{importScripts(`${s}/malinajs/${e}/malina.js`)}catch(n){throw new Error(`[REPL]: Can't load MalinaJS v.${e}`)}c("malina")}async function u(e,n,r,t){c("malina");let a={exportDefault:!0,inlineTemplate:!0,autoSubscribe:!0,name:n,localConfig:!1,autoimport:o=>`import ${o} from './${o}.xht';`};try{t&&(a=t(a,n));let o=await malina.compile(e,a);return o.result&&(o=o.result),r?await x(o):o}catch(o){throw console.error(o),new Error(`[MalinaJS] Compile error: ${o.message}: ${o.details}`)}}async function x(e){c("rollup");let r=(await(await rollup.rollup({input:"./app.js",external:()=>!0,plugins:[{name:"plugin",async resolveId(t){return t},async load(t){return t==="./app.js"?e:""}}],onwarn:()=>{}})).generate({format:"es"})).output[0].code;return v(r)}function v(e){console.log(e);let n=acorn.parse(e,{sourceType:"module",ecmaVersion:"latest"});return astring.generate(n)}async function p(code){let bundle=await rollup.rollup({input:"./__entry.js",external:!1,treeshake:!1,plugins:[{name:"resolver",async resolveId(e){return e}},{name:"files",async load(e){if(e=="./__entry.js")return code;throw new Error(`[Bundler]: File ./${e} does not exist.`)}}]}),r=await bundle.generate({format:"iife",name:"configFn",sourcemap:!1});return eval(r.output[0].code),configFn}async function E(e){try{c("rollup");let n,r=e.filter(a=>a.name=="malina.config.js")[0];return r?.body&&(n=await p(r.body)),(await(await rollup.rollup({input:"./__entry.js",external:!1,inlineDynamicImports:!0,treeshake:!1,plugins:[D(),S(e),k(),R(n)]})).generate({format:"iife",name:"Component",exports:"named",sourcemap:!1})).output[0].code}catch(n){throw n}}function D(){let e=/^\.{1,2}\/|^\//,n=/^https?:\/\/|^\/\//,r=/^malinajs\//;return{name:"rollup_plugin_module_resolver",async resolveId(t,a){return e.test(t)&&(!a||e.test(a))||n.test(t)?t:e.test(t)&&n.test(a)?M(t,a):t=="malinajs"?`${s}/malinajs/${malina?malina.version:"latest"}/runtime.js`:r.test(t)?`${s}/malinajs/${malina?malina.version:"latest"}/${t.slice(9)}`:await P(`${h}/${t}`)}}}function S(e){let n=`
        import * as malina from 'malinajs';
        import App from './App.xht';
        malina.configure({onerror: (e) => window.malina_onerror?.(e)});
        window.app?.destroy?.();
        document.body.innerHTML = '';
        if(malina.mount) {
            window.app = malina.mount(document.body, App);
        } else {
            window.app = App(document.body);
            if(window.app?.$dom) document.body.appendChild(window.app.$dom);
        }
    `;return{name:"rollup_plugin_files",async load(r){if(r=="./__entry.js")return n;if(!r.startsWith("./"))return null;r=r.replace(/^\.\//,"");let t=e.find(a=>a.name===r);if(t===void 0)throw new Error(`[Bundler]: File ./${r} does not exist.`);return t.body}}}function k(){return{name:"rollup_plugin_download",async load(e){if(!/^https?:\/\//.test(e)&&!e.startsWith(`${s}/malinajs`))return null;try{let n=await w(e);return cjs2es.cjs2es(n.body)}catch(n){throw new Error(`[Bundler]: Unable download file ${e}.`)}}}}function R(e){return{name:"rollup_plugin_malina",async transform(n,r){let t=r.match(/([^/]+).(html|ma|xht)$/);return t?{code:await u(n,t[1],null,e)}:null}}}function M(e,n){return new URL(e,n).href}async function P(e){try{let n=await w(e+"?module");if(!n.ok&&(n=await w(e),!n.ok))throw new Error(`Can't find module ${e}`);return e=n.url,e}catch(n){throw new Error(`[Bundler] ${n.message}`)}}var d={};async function w(e){if(!d[e]){let n=await fetch(e);d[e]={url:n.url,ok:n.ok,status:n.status,body:n.ok?await n.text():""}}return d[e]}var{on:m,emit:l}=g(),b=!1;try{m("init",e=>{l("init"),b=!1,$(),f(e&&e.malinaVersion||"latest"),b=!0,l("ready",{malinaVersion:malina.version,rollupVersion:rollup.VERSION}),l("malinaVersion",malina.version)}),m("bundle",async e=>{try{let n=await E(e);l("bundle",n)}catch(n){console.error(n),l("error",n.message),l("bundle","")}}),m("compile",async e=>{try{let n=e.config?await p(e.config):null,r=await u(e.code,e.name,!0,n);r.result&&(r=r.result),l("compile",r)}catch(n){console.error(n),l("error",n.message),l("compile","")}}),m("malinaVersion",async e=>{f(e),l("ready",{malinaVersion:malina.version,rollupVersion:rollup.VERSION})})}catch(e){console.error(e),l("error",e.message)}})();
